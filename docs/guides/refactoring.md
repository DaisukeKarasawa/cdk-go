# リファクタリング手順書

## 概要

このドキュメントでは、[Getting Started](../getting-started/01-prerequisites.md)で構築した基本的なブログAPIを、本格的なプロダクション対応アプリケーションに段階的に改善する手順を説明します。

**目的**: コードの品質向上、パフォーマンス最適化、保守性の向上、テストカバレッジの拡充

**前提条件**:

- [Getting Started](../getting-started/01-prerequisites.md)の全手順が完了している
- LocalStackが正常に動作している
- CDKスタックがデプロイ済みである

## 📚 リファクタリング手順

### 🚀 段階的改善アプローチ

リファクタリングは一度にすべてを変更するのではなく、段階的に進めることで安全性を確保します。

1. [準備](./refactoring/01-preparation.md) - 現状分析とリファクタリング計画
2. [コード品質改善](./refactoring/02-code-quality.md) - 構造化とベストプラクティス適用
3. [パフォーマンス最適化](./refactoring/03-performance.md) - 性能向上とキャッシング
4. [テスト追加](./refactoring/04-testing.md) - テストカバレッジの拡充
5. [インフラ改善](./refactoring/05-infrastructure.md) - CDKスタックの構造化
6. [デプロイとバリデーション](./refactoring/06-deployment.md) - 最終確認とロールバック

## 🎯 改善目標

### Before（現在の状態）

- **Lambda関数**: 134行の単一ファイル（`lambda/cmd/blog/main.go`）
- **CDKスタック**: 88行の単一ファイル（`cdk-go.go`）
- **テスト**: なし
- **ログ**: 基本的なエラーログのみ
- **パフォーマンス**: 最適化なし

### After（リファクタリング後）

- **Lambda関数**: 複数パッケージに分離された構造化されたコード
- **CDKスタック**: モジュール化されたConstructベースの構成
- **テスト**: ユニットテスト + 統合テスト + E2Eテスト
- **ログ**: 構造化ログとメトリクス収集
- **パフォーマンス**: キャッシングとCold Start対策

## 🔄 リファクタリングの原則

1. **段階的改善**: 一度に1つの側面に集中
2. **後方互換性**: APIエンドポイントの変更を最小限に
3. **テスト駆動**: 各変更の前にテストを追加
4. **ロールバック可能**: 各段階で元に戻せる状態を維持
5. **ドキュメント更新**: 変更に合わせてドキュメントを更新

## 📋 各段階の詳細

### 1. 準備段階

- 現行実装の課題分析
- Git管理とバックアップの確認
- リファクタリング方針の決定
- 改善目標の設定

### 2. コード品質改善

- ハンドラーとビジネスロジックの分離
- パッケージ構成の整理
- エラーハンドリングの統一
- Go ベストプラクティスの適用

### 3. パフォーマンス最適化

- S3アクセスの最適化
- Lambda Cold Start対策
- メモリ・タイムアウト設定の調整
- キャッシング戦略の実装

### 4. テスト追加

- ユニットテストの追加
- 統合テストの実装
- LocalStackを使ったE2Eテスト
- テストカバレッジの向上

### 5. インフラ改善

- CDKスタックの構造化
- 環境別設定の分離
- セキュリティ強化（IAM権限の最小化）
- モニタリング・ロギングの追加

### 6. デプロイとバリデーション

- リファクタリング後のデプロイ
- 動作確認とバリデーション
- パフォーマンス比較
- ロールバック手順

## ⚠️ 注意事項

### リスク管理

- **APIの破壊的変更**: エンドポイントの変更は最小限に
- **デプロイ失敗**: 各段階でロールバック手順を準備
- **パフォーマンス劣化**: 変更前後の性能測定を実施
- **データ損失**: S3データのバックアップを確認

### 推奨環境

- **Docker環境**: 統一されたGo 1.23環境での開発
- **Git管理**: 各段階でコミットを作成
- **ブランチ戦略**: 機能ブランチでの作業

## 🔗 関連ドキュメント

- [Getting Started](../getting-started/01-prerequisites.md) - 初期構築手順
- [API 使用方法](./api-usage.md) - 現在のAPI使用方法
- [運用手順](./operations.md) - デプロイ・更新手順
- [CRUD Lambda](../reference/crud-lambda.md) - 完全版Lambda実装
- [拡張ガイド](../reference/extensions.md) - 機能拡張の参考

## 🚀 開始方法

リファクタリングを開始する前に、以下を確認してください：

1. **現在の状態確認**:

   ```bash
   # LocalStackの動作確認
   docker compose ps

   # APIの動作確認
   curl -s "http://localhost:4566/restapis/$(awslocal apigateway get-rest-apis | jq -r '.items[0].id')/prod/_user_request_/posts" | jq .
   ```

2. **Git管理の確認**:
   ```bash
   git status
   git add .
   git commit -m "Before refactoring: current state"
   ```

準備ができたら、[準備段階](./refactoring/01-preparation.md)から開始してください。

---

> **💡 ヒント**: リファクタリングは時間をかけて段階的に進めることが重要です。急いで一度にすべてを変更すると、問題の特定が困難になります。
